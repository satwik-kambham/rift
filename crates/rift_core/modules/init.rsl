# Dashboard

dashboardId = -1
dashboardText = "
Welcome to rift!

Basic Keybinds:

esc - Quit Insert Mode
i - Enter Insert Mode
space q - Quit
space f - Fuzzy File Picker (with fd & fzf)
space F - File Explorer
space b - Switch Buffer
"

fn createDashboardBuffer() {
    if dashboardId == -1 {
        bufferId = createSpecialBuffer()
        setBufferContent(bufferId, dashboardText)
        setActiveBuffer(bufferId)
    }
}

createDashboardBuffer()

#################

# Agentic Chat

fn toolDeclarations() {
    return
"[
    {
        \"type\": \"function\",
        \"function\": {
            \"name\": \"run_shell_command\",
            \"description\": \"Run a shell command and return the output\",
            \"parameters\": {
                \"type\": \"object\",
                \"properties\": {
                    \"command\": {\"type\": \"string\"}
                },
                \"required\": [\"command\"]
            }
        }
    },
    {
        \"type\": \"function\",
        \"function\": {
            \"name\": \"find_file\",
            \"description\": \"Returns paths matching regex pattern by searching recursively in the workspace folder, returning absolute paths. Does not accept glob patterns.\",
            \"parameters\": {
                \"type\": \"object\",
                \"properties\": {
                    \"pattern\": {\"type\": \"string\"}
                },
                \"required\": [\"pattern\"]
            }
        }
    },
    {
        \"type\": \"function\",
        \"function\": {
            \"name\": \"search_workspace\",
            \"description\": \"Grep search in the current workspace for matching patterns\",
            \"parameters\": {
                \"type\": \"object\",
                \"properties\": {
                    \"pattern\": {\"type\": \"string\"}
                },
                \"required\": [\"pattern\"]
            }
        }
    },
    {
        \"type\": \"function\",
        \"function\": {
            \"name\": \"read_file\",
            \"description\": \"Get the content of a file with line numbers\",
            \"parameters\": {
                \"type\": \"object\",
                \"properties\": {
                    \"path\": {\"type\": \"string\"}
                },
                \"required\": [\"path\"]
            }
        }
    },
    {
        \"type\": \"function\",
        \"function\": {
            \"name\": \"write_file\",
            \"description\": \"Writes content to a specified file replacing the existing content.\",
            \"parameters\": {
                \"type\": \"object\",
                \"properties\": {
                    \"file_path\": {\"type\": \"string\"},
                    \"content\": {\"type\": \"string\"}
                },
                \"required\": [\"file_path\", \"content\"]
            }
        }
    },
    {
        \"type\": \"function\",
        \"function\": {
            \"name\": \"replace\",
            \"description\": \"Replaces text within a file. Can replace single or multiple occurrences.\",
            \"parameters\": {
                \"type\": \"object\",
                \"properties\": {
                    \"file_path\": {\"type\": \"string\"},
                    \"old_string\": {\"type\": \"string\"},
                    \"new_string\": {\"type\": \"string\"}
                },
                \"required\": [\"file_path\", \"old_string\", \"new_string\"]
            }
        }
    }
]"
}

fn agentRunShellCommand(command) {
    outputs = runShellCommand(command, getWorkspaceDir())
    return "STDOUT:\n" + tableGet(outputs, "stdout") + "\nSTDERR:\n" + tableGet(outputs, "stderr")
}

fn agentFindFile(pattern) {
    results = runShellCommand("fd --type f --strip-cwd-prefix --full-path --absolute-path " + pattern, getWorkspaceDir())
    return tableGet(results, "stdout")
}

fn agentSearchWorkspace(pattern) {
    results = runShellCommand("rg " + pattern, getWorkspaceDir())
    return tableGet(results, "stdout")
}

llmChatId = -1
chatInput = ""
chatHistory = createArray()
pendingToolCalls = createArray()

fn renderLLMChat() {
    content = ""
    i = 0
    loop {
        if i >= arrayLen(chatHistory) { break }
        message = arrayGet(chatHistory, i)
        content = content + "\n------\n" + tableGet(message, "role") + ":\n" + tableGet(message, "content")
        toolCalls = tableGet(message, "tool_calls")
        if toolCalls != null {
            content = content + "\n\n" + toJson(toolCalls)
        }
        content = content + "\n------\n"
        i = i + 1
    }
    if arrayLen(pendingToolCalls) != 0 {
        i = 0
        loop {
            if i >= arrayLen(pendingToolCalls) { break }
            toolCall = arrayGet(pendingToolCalls, i)
            content = content + "\n" + toJson(toolCall) + "\n"
            i = i + 1
        }
    }
    content = content + "\n------\n" + chatInput + "\n------\n"
    setBufferContent(llmChatId, content)
}

fn requestChatCompletion() {
    apiKey = getEnvVar("OPENROUTER_KEY")
    
    request = createTable()
    tableSet(request, "model", "mistralai/devstral-small")
    tableSet(request, "messages", chatHistory)
    tableSet(request, "tools", fromJson(toolDeclarations()))
    tableSet(request, "stream", false)
    tableSet(request, "temperature", 0.3)
    tableSet(request, "seed", 42)

    body = toJson(request)
    response = postRequestWithBearerToken("https://openrouter.ai/api/v1/chat/completions", body, apiKey)
    response = fromJson(response)
    message = tableGet(arrayGet(tableGet(response, "choices"), 0), "message")
    toolCalls = tableGet(message, "tool_calls")
    
    if toolCalls != null {
        i = arrayLen(toolCalls)
        loop {
            if i <= 0 { break }
            toolCall = arrayGet(toolCalls, i - 1)
            
            arrayPushBack(pendingToolCalls, toolCall)
            
            toolName = tableGet(tableGet(toolCall, "function"), "name")
            toolArgs = fromJson(tableGet(tableGet(toolCall, "function"), "arguments"))
            toolCallId = tableGet(toolCall, "id")
            
            i = i - 1
        }
    }
    
    arrayPushBack(chatHistory, message)

    renderLLMChat()
}

fn getToolCallResult(allowed) {
    toolCall = arrayPopBack(pendingToolCalls)
    
    toolName = tableGet(tableGet(toolCall, "function"), "name")
    toolArgs = fromJson(tableGet(tableGet(toolCall, "function"), "arguments"))
    toolCallId = tableGet(toolCall, "id")
    
    result = "Tool call request denied by user. Await further instructions."
    
    if allowed {
        if toolName == "run_shell_command" {
            result = agentRunShellCommand(tableGet(toolArgs, "command"))
        }
        if toolName == "find_file" {
            result = agentFindFile(tableGet(toolArgs, "pattern"))
        }
        if toolName == "search_workspace" {
            result = agentSearchWorkspace(tableGet(toolArgs, "pattern"))
        }
        if toolName == "read_file" {
            result = agentReadFile(getWorkspaceDir(), tableGet(toolArgs, "path"))
        }
        if toolName == "write_file" {
            result = agentFindFile(getWorkspaceDir(), tableGet(toolArgs, "file_path"), tableGet(toolArgs, "content"))
        }
        if toolName == "replace" {
            result = agentFindFile(getWorkspaceDir(), tableGet(toolArgs, "file_path"), tableGet(toolArgs, "old_string"), tableGet(toolArgs, "new_string"))
        }
    }
    
    message = createTable()
    tableSet(message, "role", "tool")
    tableSet(message, "content", result)
    tableSet(message, "name", toolName)
    tableSet(message, "tool_call_id", toolCallId)
    arrayPushBack(chatHistory, message)
    
    renderLLMChat()

    if arrayLen(pendingToolCalls) == 0 {
        requestChatCompletion()
    }
}

fn allowToolCall() { getToolCallResult(true) }
fn denyToolCall() { getToolCallResult(false) }

fn sendMessage() {
    if arrayLen(pendingToolCalls) == 0 {
        message = createTable()
        tableSet(message, "role", "user")
        tableSet(message, "content", chatInput)
        arrayPushBack(chatHistory, message)
        
        renderLLMChat()
    
        requestChatCompletion()
    }
}

fn llmChatInputUpdated() {
    chatInput = getBufferInput(llmChatId)
    renderLLMChat()
}

fn llmChatAddSpace() {
    chatInput = getBufferInput(llmChatId)
    chatInput = chatInput + " "
    setBufferInput(llmChatId, chatInput)
    renderLLMChat()
}

fn llmChatClearInput() {
    chatInput = ""
    setBufferInput(llmChatId, chatInput)
}

fn createLLMChat() {
    if llmChatId == -1 {
        bufferId = createSpecialBuffer()
        llmChatId = bufferId
        registerBufferKeybind(bufferId, "nor enter", sendMessage)
        registerBufferKeybind(bufferId, "ins space", llmChatAddSpace)
        registerBufferKeybind(bufferId, "ins backspace", llmChatClearInput)
        registerBufferKeybind(bufferId, "nor y", allowToolCall)
        registerBufferKeybind(bufferId, "nor n", denyToolCall)
        registerBufferInputHook(bufferId, llmChatInputUpdated)
        renderLLMChat()
    }
    setActiveBuffer(llmChatId)
}

registerGlobalKeybind("nor space c", createLLMChat)

############

# Fuzzy Find File

fuzzyFileFinderId = -1
fuzzyFileFinderInput = ""
fuzzyFileFinderResults = createArray()
fuzzySelectedEntry = 0

fn renderFuzzyFileFinder() {
    content = "\n------\n" + fuzzyFileFinderInput + "\n------\n"
    i = 0
    loop {
        if i >= arrayLen(fuzzyFileFinderResults) { break }
        result = arrayGet(fuzzyFileFinderResults, i)
        if fuzzySelectedEntry == i {
            content = content + "\n > " + result            
        } if fuzzySelectedEntry != i {
            content = content + "\n   " + result 
        }
        i = i + 1
    }
    setBufferContent(fuzzyFileFinderId, content)
}

fn fuzzyFileFinderInputUpdated() {
    fuzzyFileFinderInput = getBufferInput(fuzzyFileFinderId)
    results = runShellCommand("fd --type f --strip-cwd-prefix --full-path --absolute-path | fzf -f " + fuzzyFileFinderInput, getWorkspaceDir())
    fuzzyFileFinderResults = stringSplitLines(tableGet(results, "stdout"))
    renderFuzzyFileFinder()
    fuzzySelectedEntry = 0
}

fn fuzzyFileFinderAddSpace() {
    fuzzyFileFinderInput = getBufferInput(fuzzyFileFinderId)
    fuzzyFileFinderInput = fuzzyFileFinderInput + " "
    setBufferInput(fuzzyFileFinderId, fuzzyFileFinderInput)
    renderFuzzyFileFinder()
}

fn fuzzyFileFinderClearInput() {
    fuzzyFileFinderInput = ""
    setBufferInput(fuzzyFileFinderId, fuzzyFileFinderInput)
}

fn  fuzzyFileFinderCycleIndex() {
    fuzzySelectedEntry = fuzzySelectedEntry + 1
    if fuzzySelectedEntry >= arrayLen(fuzzyFileFinderResults) { fuzzySelectedEntry = 0 }
    renderFuzzyFileFinder()
}

fn fuzzyFileFinderSelect() {
    if fuzzySelectedEntry < arrayLen(fuzzyFileFinderResults) {
        path = arrayGet(fuzzyFileFinderResults, fuzzySelectedEntry)
        openFile(path)
    }
}

fn createFuzzyFileFinder() {
    if fuzzyFileFinderId == -1 {
        bufferId = createSpecialBuffer()
        fuzzyFileFinderId = bufferId
        registerBufferKeybind(bufferId, "ins space", fuzzyFileFinderAddSpace)
        registerBufferKeybind(bufferId, "ins backspace", fuzzyFileFinderClearInput)
        registerBufferKeybind(bufferId, "nor tab", fuzzyFileFinderCycleIndex)
        registerBufferKeybind(bufferId, "nor enter", fuzzyFileFinderSelect)
        registerBufferInputHook(bufferId, fuzzyFileFinderInputUpdated)
        renderFuzzyFileFinder()
    }
    setActiveBuffer(fuzzyFileFinderId)
}

registerGlobalKeybind("nor space f", createFuzzyFileFinder)
